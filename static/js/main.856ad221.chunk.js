(this["webpackJsonpdicom-image-viewer"]=this["webpackJsonpdicom-image-viewer"]||[]).push([[0],{197:function(e,t,n){e.exports=n(339)},202:function(e,t,n){},339:function(e,t,n){"use strict";n.r(t);var a,i,o=n(0),r=n.n(o),l=n(17),s=n.n(l),c=(n(202),n(76)),d=n(68),m=n(69),u=n(187),h=n(74),f=n(28),v=n(185),g=(n(204),n(346)),w=n(347),p=n(186),C=n(188),M=n(170),x=n(338).fromEvent;!function(e){e[e.PixelHUMaxMin=0]="PixelHUMaxMin",e[e.WindowCenter=1]="WindowCenter",e[e.AbdomenSoftTissues=2]="AbdomenSoftTissues",e[e.SpineSoftTissues=3]="SpineSoftTissues",e[e.SpineBone=4]="SpineBone",e[e.Brain=5]="Brain",e[e.Lungs=6]="Lungs"}(i||(i={}));var y=(a={},Object(f.a)(a,i.AbdomenSoftTissues,{W:400,L:50}),Object(f.a)(a,i.SpineSoftTissues,{W:250,L:50}),Object(f.a)(a,i.SpineBone,{W:1800,L:400}),Object(f.a)(a,i.Brain,{W:80,L:40}),Object(f.a)(a,i.Lungs,{W:1500,L:-600}),a),E={borderWidth:2,borderColor:"#666",borderStyle:"dashed",borderRadius:5,width:800,height:150},W={frameIndexes:[],currFrameIndex:0,multiFrameInfo:"",windowCenter:0,windowWidth:-1,useWindowCenter:0,useWindowWidth:-1,pixelMax:0,pixelMin:0,resX:0,resY:0,photometric:"",modality:"",hasDICOMExtension:!0,isValidMouseDown:!1};function I(e){var t,n=e.mode,a=e.windowItem,o=e.currNormalizeMode,l=e.onChange,s=null!==(t=null!==a&&void 0!==a?a:y[n])&&void 0!==t?t:null;return r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{radio:!0,label:i[n],name:"checkboxRadioGroup",value:n,checked:o===n,onChange:l}),s?" c:".concat(s.L,", w:").concat(s.W,"  "):"  ")}var F=function(e){Object(h.a)(n,e);var t=Object(u.a)(n);function n(){var e;return Object(d.a)(this,n),(e=t.call(this,{})).myCanvasRef=void 0,e.files=void 0,e.isOnlineMode=!0,e.currentImage=void 0,e.clientX=void 0,e.clientY=void 0,e.handleNormalizeModeChange=function(t,n){var a=n.value;if(e.setState({useWindowWidth:-1,useWindowCenter:0,currNormalizeMode:a}),e.currentImage){var i=e.state.currFrameIndex;e.renderFrame(e.currentImage,i,a,-1)}},e.renderImage=function(t){if(console.log("renderImage bytelength:",t.byteLength),t){var n,a;try{a=(n=M.Series.parseImage(new DataView(t))).getNumberOfFrames()}catch(o){console.log("parse dicom error:",o)}if(a>1){var i="It's multi-frame file (n=".concat(a,")");e.setState({multiFrameInfo:i})}else e.setState({multiFrameInfo:""});e.setState({frameIndexes:Array.from({length:a},(function(e,t){return{text:t,value:t}})),currFrameIndex:0}),e.currentImage=n,e.renderFrame(e.currentImage,0)}},e.renderFrame=function(t,n,a,i,o){console.log("switch to ".concat(n," Frame"));var r,l=!1,s=0,c=t.getPhotometricInterpretation(),d=t.getModality();null!==c&&(-1!==c.trim().indexOf("RGB")?(l=!0,s=t.getPlanarConfig()||0):-1!==c.trim().toLowerCase().indexOf("palette")&&(l=!0));try{r=t.getInterpretedData(!1,!0,n)}catch(U){return void console.log("read dicom InterpretedData error:",U)}var m,u,h=r.numCols,f=r.numRows,v=t.getWindowCenter(),g=t.getWindowWidth();e.setState({windowCenter:v,windowWidth:g,pixelMax:r.max,pixelMin:r.min,resX:h,resY:f,modality:d,photometric:c}),void 0===a&&(a=e.state.currNormalizeMode),void 0===i&&(i=e.state.useWindowWidth),void 0===o&&(o=e.state.useWindowCenter);var w=e.getNormalizationRange(i,o,a,g,v,r.max,r.min);if(m=w.max,(u=w.min)!==r.min||m!==r.max)for(var p=0;p<r.data.length;p+=1)r.data[p]>m?r.data[p]=m:r.data[p]<u&&(r.data[p]=u);if(e.myCanvasRef.current){var C=document.createElement("canvas");C.width=h,C.height=f;var M=C.getContext("2d");if(M){var x=M.createImageData(h,f),y=x.data;if(l)if(0===s)for(var E=r.data,W=0,I=0;W<y.byteLength;W+=1,I+=1)y[W]=E[I],(W+2)%4===0&&(y[W+1]=255,W+=1);else for(var F=r.data,b=F.length/3,S=0,N=0;S<y.byteLength;S+=1,N+=1){var D=Math.floor(S/4);(S+1)%4===1?y[S]=F[D]:(S+1)%4===2?y[S]=F[D+b]:(S+1)%4===3&&(y[S]=F[D+2*b],y[S+1]=255,S+=1)}else{for(var O=m-u,L=new Uint8ClampedArray(r.data.length),R=0;R<r.data.length;R+=1)L[R]=255*(r.data[R]-u)/O;for(var z=0,k=0;z<y.byteLength;z+=4,k+=1)y[z]=L[k],y[z+1]=L[k],y[z+2]=L[k],y[z+3]=255}M.putImageData(x,0,0);var j=e.resizeTotFit(h,f);1!==j&&console.log("scale:",j);var T=e.myCanvasRef.current;T.width=h/j,T.height=f/j,T.getContext("2d").drawImage(C,0,0,T.width,T.height)}}else console.log("this.myCanvasRef is not ready, return")},e.fetchFile=function(t){if(e.setState({currFilePath:decodeURI(t)}),e.checkDicomNameAndResetState(t))if(0===t.indexOf("file://")){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){var t=n.response;e.renderImage(t)},n.send()}else{console.log("Starting XHR request for",t);var a=new XMLHttpRequest;a.open("GET",t,!1),a.overrideMimeType("text/plain; charset=x-user-defined"),a.send(),console.log("Finished XHR request");var i,o,r,l=a.responseText;i=new ArrayBuffer(l.length),o=new DataView(i),l.split("").forEach((function(e,t){r=e.charCodeAt(0),o.setUint8(t,255&r)}));var s=o.buffer;e.renderImage(s)}},e.switchImage=function(t){e.setState({currFileNo:t});var n=e.files[t-1];console.log("switch to image:",t,n),e.isOnlineMode?e.fetchFile(n):e.loadFile(n)},e.onDropFile=function(t){t.length>0&&(t.sort((function(e,t){return e.name.localeCompare(t.name)})),e.isOnlineMode=!1,e.files=t,e.setState({totalFiles:e.files.length,currFileNo:1}),e.loadFile(e.files[0]))},e.handleSwitchFrame=function(t,n){var a=n.value;console.log("switch frame:",a),e.setState({currFrameIndex:a}),e.renderFrame(e.currentImage,a)},e.onKeyDown=function(t){var n=e.state,a=n.totalFiles,i=n.currFileNo;if(a>1){if("right"===t){if((i+=1)>a)return}else if("left"===t&&(i-=1)<1)return;e.switchImage(i)}},e.onMouseCanvasDown=function(t){console.log("onMouseDown:",t),e.setState({isValidMouseDown:!0}),e.clientX=t.clientX,e.clientY=t.clientY,window.addEventListener("mousemove",e.onMouseMove)},e.onMouseUp=function(t){console.log("onMouseUp:",t),e.setState({isValidMouseDown:!1}),window.removeEventListener("mousemove",e.onMouseMove)},e.onMouseMove=function(t){var n=e.state,a=n.isValidMouseDown,i=n.windowCenter,o=n.windowWidth,r=n.pixelMax,l=n.pixelMin,s=n.useWindowWidth,c=n.useWindowCenter,d=n.currFrameIndex,m=n.currNormalizeMode;if(a){var u=e.getNormalizationRange(s,c,m,o,i,r,l),h=(u.max,u.min,u.tmpWindowCenter),f=u.tmpWindowWidth;if(void 0!==h&&void 0!==f){var v=t.clientX-e.clientX,g=e.clientY-t.clientY,w=f+v;if(w<=1&&(v=(w=2)-f),0===v&&0===g)return;var p=h+g;e.setState({useWindowCenter:p,useWindowWidth:w}),e.renderFrame(e.currentImage,d,m,w,p)}}e.clientX=t.clientX,e.clientY=t.clientY},e.state=Object(c.a)({currNormalizeMode:i.WindowCenter,ifWindowCenterMode:!0,currFilePath:"",currFileNo:0,totalFiles:0},W),e.myCanvasRef=r.a.createRef(),e.files=[],e.clientX=0,e.clientY=0,e}return Object(m.a)(n,[{key:"componentDidMount",value:function(){window.addEventListener("mouseup",this.onMouseUp);var e=window.location.href;if(-1!==e.toLowerCase().indexOf(".dcm")||-1!==e.toLowerCase().indexOf(".dicom")){var t=e.indexOf("#");if(t>-1){var n=e.substring(t+1,e.length);this.onOpenFileURLs(n)}}}},{key:"onOpenFileURLs",value:function(e){var t=this,n=e.split("file://");n.sort((function(e,t){return e.localeCompare(t)})),console.log("sorted files:",n),this.files=[],n.forEach((function(e,n){0!==n&&t.files.push("file://".concat(e))})),this.setState({totalFiles:this.files.length,currFileNo:1}),this.fetchFile(this.files[0])}},{key:"checkDicomNameAndResetState",value:function(e){var t=this.myCanvasRef.current;t&&(console.log("reset canvas"),t.getContext("2d").clearRect(0,0,t.width,t.height));return!1===e.toLowerCase().endsWith(".dcm")&&!1===e.toLowerCase().endsWith(".dicom")?(console.log("not dicom file"),this.setState(Object(c.a)({},W,{hasDICOMExtension:!1})),!1):(this.setState(Object(c.a)({},W)),!0)}},{key:"loadFile",value:function(e){var t=this;if(this.setState({currFilePath:e.name}),this.checkDicomNameAndResetState(e.name)){var n=new FileReader;n.onload=function(){var e=n.result;t.renderImage(e)},n.onabort=function(){return console.log("file reading was aborted")},n.onerror=function(){return console.log("file reading has failed")},n.readAsArrayBuffer(e)}}},{key:"resizeTotFit",value:function(e,t){var n=1,a=1280,i=1024;if(e<=a&&t<=i)return n;var o=e/a,r=t/i;return n=o>=r?o:r}},{key:"getNormalizationRange",value:function(e,t,n,a,o,r,l){var s,c,d,m;if(e>=0&&void 0!==t)d=t,m=e;else if(n===i.WindowCenter)null!==a&&a>=0&&null!==o&&(d=o,m=a);else if(n===i.PixelHUMaxMin);else{var u=y[n];d=u.L,m=u.W}return void 0!==m&&void 0!==d?(c=d-Math.floor(m/2),s=d+Math.floor(m/2)):(s=r,c=l),{max:s,min:c,tmpWindowCenter:d,tmpWindowWidth:m}}},{key:"render",value:function(){var e=this.state,t=e.currFilePath,n=e.multiFrameInfo,a=e.frameIndexes,o=e.currFrameIndex,l=(e.ifWindowCenterMode,e.currNormalizeMode),s=e.windowCenter,c=e.windowWidth,d=e.pixelMax,m=e.pixelMin,u=e.resX,h=e.resY,f=e.photometric,g=e.modality,M=e.currFileNo,y=e.totalFiles,W=e.hasDICOMExtension,F=e.useWindowWidth,b=e.useWindowCenter,S="[meta]";S+=" modality:".concat(g,";photometric:").concat(f),u&&h&&(S+=" resolution:".concat(u,"x").concat(h)),n&&(S+="; ".concat(n));var N=this.getNormalizationRange(F,b,l,c,s,d,m),D=(N.max,N.min,N.tmpWindowCenter),O=N.tmpWindowWidth;return r.a.createElement(C.a,{allowRepeat:!0,keyName:"right,left",onKeyDown:this.onKeyDown},r.a.createElement("div",{className:"flex-container"},r.a.createElement("div",null,r.a.createElement("div",{className:"flex-container"},r.a.createElement("div",null,"DICOM Image Viewer (feat: 1. click DICOM url 2. click extension icon (or ctrl+u/cmd+u) to open ",r.a.createElement("br",null),"viewer page 3. drag any DICOM file into Chrome without opening viewer first 4.",r.a.createElement("a",{href:"https://github.com/grimmer0125/dicom-web-viewer/wiki"}," ","More (e.g. CLI and Instruction)!"))),r.a.createElement("div",null,r.a.createElement("div",{className:"flex-container"},r.a.createElement(p.a,{preventDropOnDocument:!1,style:E,getDataTransferItems:function(e){return x(e)},onDrop:this.onDropFile},r.a.createElement("div",{style:{height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}},r.a.createElement("div",null,r.a.createElement("p",null," ","Try dropping DICOM image files/folder here, ",r.a.createElement("br",null),"or click here to select files to view. ",r.a.createElement("br",null),"You need to enable file url access in extenstion DETAILS setting page. ",r.a.createElement("br",null)," Use right/left key to switch & mouse press+move to change window center (level) ",r.a.createElement("br",null),"and widow width"))))),r.a.createElement("div",{style:{display:"flex",justifyContent:"center"}},S),r.a.createElement("div",{style:{display:"flex",justifyContent:"center"}},r.a.createElement("div",null,r.a.createElement("div",{className:"flex-container"},"pixel/HU max:".concat(d,", min:").concat(m,"; useWindowCenter:").concat(null!==D&&void 0!==D?D:"",", useWindowWidth:").concat(null!==O&&void 0!==O?O:"","; Normalization mode:"),r.a.createElement("br",null),"(WindowCenter mode will fallback to Pixel/HU MaxMin if no value):"),r.a.createElement("div",null,r.a.createElement(I,{mode:i.WindowCenter,windowItem:c>=0?{L:s,W:c}:void 0,currNormalizeMode:l,onChange:this.handleNormalizeModeChange}),r.a.createElement(I,{mode:i.PixelHUMaxMin,currNormalizeMode:l,onChange:this.handleNormalizeModeChange})),r.a.createElement("div",null,r.a.createElement(I,{mode:i.AbdomenSoftTissues,currNormalizeMode:l,onChange:this.handleNormalizeModeChange}),r.a.createElement(I,{mode:i.SpineSoftTissues,currNormalizeMode:l,onChange:this.handleNormalizeModeChange}),r.a.createElement(I,{mode:i.SpineBone,currNormalizeMode:l,onChange:this.handleNormalizeModeChange})),r.a.createElement("div",null,r.a.createElement(I,{mode:i.Brain,currNormalizeMode:l,onChange:this.handleNormalizeModeChange}),r.a.createElement(I,{mode:i.Lungs,currNormalizeMode:l,onChange:this.handleNormalizeModeChange}))),r.a.createElement("div",{style:{display:"flex",justifyContent:"center"}},r.a.createElement("div",null," ",a.length>1?r.a.createElement(w.a,{placeholder:"Switch Frame",selection:!0,onChange:this.handleSwitchFrame,options:a,value:o}):null," ")," ")," ")),y>0?r.a.createElement("div",{style:{display:"flex",justifyContent:"center"}},r.a.createElement("div",{style:{width:600}},r.a.createElement("div",{style:{display:"flex",justifyContent:"center"}},"".concat(t,". ").concat(M,"/").concat(y)),r.a.createElement(v.a,{value:M,step:1,min:1,max:y,onChange:this.switchImage}))):null,W?r.a.createElement("div",{style:{display:"flex",justifyContent:"center"}},r.a.createElement("canvas",{onMouseDown:this.onMouseCanvasDown,ref:this.myCanvasRef,width:128,height:128})):null)))}}]),n}(o.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(F,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[197,1,2]]]);
//# sourceMappingURL=main.856ad221.chunk.js.map